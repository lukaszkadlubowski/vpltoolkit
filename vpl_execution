#!/bin/bash
rm -f $0

if [ -f ./env.sh ] ; then
    source ./env.sh
elif [ -f $HOME/env.sh ] ; then
    source $HOME/env.sh
else
    echo "⚠ File \"env.sh\" is missing!" && exit 0
fi

[ -z "$MODE" ] && echo "⚠ Variable \"MODE\" is not defined!" && exit 0
if [ "$MODE" = "RUN" ] ; then
    CMD="$RUNDIR/run.sh"
elif [ "$MODE" = "EVAL" ] ; then
    CMD="$RUNDIR/eval.sh"
else
    echo "⚠ Invalid \"MODE\" selected!" && exit 0
fi

[ ! -f "$CMD" ] && echo "⚠ File \"$CMD\" not found!" && exit 0
[ -z "$RUNDIR" ] && echo "⚠ Variable \"RUNDIR\" is not defined!" && exit 0

### launch command in online vs offline mode 

LAUNCHCMD="bash"
[ "$DEBUG" = "1" ] && LAUNCHCMD="bash -x"

if [ "$ONLINE" -eq "0" ] ; then
    DOCKER="gblin/vpljail" 
     # check if docker image is already installed
    docker image inspect $DOCKER &> /dev/null
    [ $? -ne 0 ] && echo "⚠ Docker image \"$DOCKER\" is required, but not installed!" && exit 0
    DOCKERCMD="docker run -i -v $RUNDIR:$RUNDIR -w $RUNDIR -t $DOCKER"
    $DOCKERCMD $LAUNCHCMD $CMD $ARGS
    echo "=> $DOCKERCMD bash"
else
    cd $RUNDIR && $LAUNCHCMD $CMD $ARGS
fi

# Let's rock
